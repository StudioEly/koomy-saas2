Tu es lâ€™assistant dÃ©veloppeur chargÃ© dâ€™implÃ©menter la logique business de lâ€™application Koomy (gestion de communautÃ©s : syndicats, associations, clubs sportifs, etc.).
Le code existe dÃ©jÃ  (back office + app client + site public), tu dois analyser le repo et adapter tes choix Ã  la stack actuelle (Node/Express, Laravel, Rails, Nest, etc.).

ğŸ¯ Objectif global

Ajouter une gestion de plans tarifaires (pricing) au niveau des communautÃ©s.

Appliquer ces plans dans toute la logique mÃ©tier :

back office (admin Koomy + admins de communautÃ©),

API,

app client,

site public (page â€œTarifsâ€ / â€œPricingâ€).

PrÃ©parer lâ€™intÃ©gration Ã  Stripe (paiement carte bancaire) sans tout coder en dur cÃ´tÃ© Stripe (prÃ©voir la structure et les hooks).

1ï¸âƒ£ Plans tarifaires Ã  implÃ©menter

CrÃ©er un modÃ¨le / table plans (ou Ã©quivalent) avec au minimum :

id

code (string, unique):

STARTER_FREE

COMMUNAUTE_STANDARD

COMMUNAUTE_PRO

ENTREPRISE_CUSTOM

WHITE_LABEL

name (string, affichage)

description (texte court)

max_members (int ou null illimitÃ©)

price_month_eur (decimal, nullable)

price_year_eur (decimal, nullable)

is_public (bool) â€“ visible sur la page pricing ou non

is_custom (bool) â€“ pour les plans sur devis

is_white_label (bool) â€“ pour le plan marque blanche

PrÃ©voir un script de seed avec les valeurs suivantes :

STARTER_FREE â€“ â€œStarterâ€

max_members = 50

price_month_eur = 0

price_year_eur = 0

is_public = true

COMMUNAUTE_STANDARD â€“ â€œCommunautÃ© Plusâ€

max_members = 1000

price_month_eur = 9.90

price_year_eur = 99

is_public = true

COMMUNAUTE_PRO â€“ â€œCommunautÃ© Proâ€

max_members = 5000

price_month_eur = 29

price_year_eur = 290

is_public = true

ENTREPRISE_CUSTOM â€“ â€œGrand Compteâ€

max_members = null (illimitÃ©)

price_month_eur = null

price_year_eur = null

is_public = true

is_custom = true

WHITE_LABEL â€“ â€œKoomy White Labelâ€

max_members = null (illimitÃ©)

price_month_eur = null

price_year_eur = 4900 (prix indicatif min)

is_public = true

is_white_label = true

2ï¸âƒ£ Lier les plans aux communautÃ©s

Identifier le modÃ¨le correspondant Ã  une communautÃ© (ex : Community, Organisation, etc.) et :

Ajouter les champs suivants :

plan_id (FK vers plans)

member_count (int, mis Ã  jour automatiquement)

Ã©ventuellement billing_status (TRIALING, ACTIVE, PAST_DUE, CANCELED, etc.)

Ã©ventuellement stripe_customer_id, stripe_subscription_id (nullable, pour la suite)

RÃ¨gle par dÃ©faut :

Lors de la crÃ©ation dâ€™une nouvelle communautÃ©, affecter automatiquement le plan STARTER_FREE.

3ï¸âƒ£ Logique de quota de membres

Partout oÃ¹ un membre est crÃ©Ã©/ajoutÃ© Ã  une communautÃ© (modÃ¨le Member, UserCommunity, etc.) :

Avant lâ€™ajout :

RÃ©cupÃ©rer la communautÃ© et son plan.

Compter le nombre de membres actifs (member_count ou COUNT() si tu prÃ©fÃ¨res).

Si plan.max_members nâ€™est pas null et member_count >= plan.max_members, alors :

Refuser la crÃ©ation du nouveau membre cÃ´tÃ© backend.

Retourner une erreur structurÃ©e, par exemple :

{
  "error": "MEMBER_LIMIT_REACHED",
  "message": "Votre communautÃ© a atteint la limite de membres pour votre plan actuel. Merci de mettre Ã  niveau votre abonnement."
}


AprÃ¨s crÃ©ation/suppression :

Mettre Ã  jour member_count de faÃ§on fiable (trigger DB, hook ORM ou service dÃ©diÃ©).

4ï¸âƒ£ IntÃ©gration dans le back office

Dans le back office, ajouter :

Une page / section â€œPlans & facturationâ€ pour chaque communautÃ© :

Afficher :

Plan actuel (nom, limites, prix).

Nombre de membres actuel vs. limite (ex : â€œ430 / 1000â€).

Statut de facturation (si existant).

Bouton â€œMettre Ã  niveauâ€ ou â€œChanger de planâ€.

Un Ã©cran global (admin Koomy) :

Liste de toutes les communautÃ©s avec :

Nom

Type (syndicat, association, club sportif, etc. si dÃ©jÃ  prÃ©sent)

Plan actuel

Nombre de membres

Indicateur si proche de la limite (par ex. > 80%).

Logique de changement de plan :

CrÃ©er une action backend (route API) du type POST /communities/:id/change-plan :

ParamÃ¨tres : plan_code ou plan_id.

VÃ©rifier les droits (seul lâ€™admin de la communautÃ© ou lâ€™admin global Koomy peut changer).

Si passage dâ€™un plan plus bas vers plus haut â†’ autorisÃ©.

Si passage dâ€™un plan plus haut vers un plan plus bas, vÃ©rifier que member_count <= new_plan.max_members.
Sinon, retourner une erreur : impossible de downgrader tant que la communautÃ© a trop de membres.

5ï¸âƒ£ Page publique â€œTarifs / Pricingâ€

Sur le site public Koomy, ajouter une page (front) dÃ©diÃ©e aux tarifs, par exemple /pricing ou /tarifs :

Afficher 5 cartes (ou sections) pour :

Starter (gratuit, jusquâ€™Ã  50 membres)

CommunautÃ© Plus (9,90 â‚¬/mois ou 99 â‚¬/an, jusquâ€™Ã  1000 membres)

CommunautÃ© Pro (29 â‚¬/mois ou 290 â‚¬/an, jusquâ€™Ã  5000 membres)

Grand Compte (sur devis)

Marque Blanche (Ã  partir de 4900 â‚¬/an)

Pour chaque plan public & non custom, afficher :

Nom

Prix mensuel & annuel

Limite de membres

CTA :

Si lâ€™utilisateur nâ€™est pas connectÃ© : â€œCrÃ©er une communautÃ© avec ce planâ€

Si connectÃ© : â€œChoisir ce plan pour ma communautÃ©â€

Pour les plans Grand Compte et White Label :

Pas de souscription directe, mais un bouton â€œDemander un devisâ€ (qui ouvre un formulaire simple de contact ou envoie un email Ã  un contact admin dÃ©fini dans la config).

Important : adapter le code front Ã  la stack existante (React, Next.js, Blade, etc.).
Si possible, centraliser les dÃ©finitions des plans dans lâ€™API et rÃ©cupÃ©rer la liste des plans via un endpoint GET /plans?public=true.

6ï¸âƒ£ API & app client

Exposer la notion de plan dans lâ€™API :

Dans les rÃ©ponses autour des communautÃ©s (GET /me/communities, GET /community/:id, etc.), inclure :

plan : { code, name, max_members, price_month_eur, price_year_eur }

member_count

App client (mobile/web) :

Lorsque lâ€™utilisateur admin tente dâ€™ajouter un membre et que la limite est atteinte, afficher :

Un message clair expliquant :

la limite du plan

la possibilitÃ© de mettre Ã  niveau

PrÃ©voir un Ã©cran â€œMon planâ€ dans la partie ParamÃ¨tres de la communautÃ©.

7ï¸âƒ£ PrÃ©paration Ã  Stripe (structure)

Sans tout implÃ©menter dans le dÃ©tail, prÃ©voir dans le code :

Un mapping plan_code â†’ stripe_price_id_month / stripe_price_id_year configurable via variables dâ€™environnement (ex : STRIPE_PRICE_STANDARD_MONTH, etc.).

Une route backend dâ€™intention de souscription, par exemple :

POST /billing/checkout-session

ParamÃ¨tres : community_id, plan_code, billing_cycle (month ou year)

CrÃ©er une Session de paiement Stripe (si la lib Stripe est dÃ©jÃ  prÃ©sente) ou au minimum structurer la fonction Ã  implÃ©menter plus tard.

Un champ billing_status mis Ã  jour aprÃ¨s succÃ¨s du paiement (prÃ©voir la structure pour une future implÃ©mentation des webhooks Stripe).

Si Stripe nâ€™est pas encore installÃ© dans le projet, crÃ©Ã© la structure (services, handlers) commentÃ©e ou avec TODO explicites.

8ï¸âƒ£ SÃ©curitÃ© & tests

Ajouter des middlewares/guards pour vÃ©rifier :

Que seuls les admins peuvent changer le plan de leur communautÃ©.

Que les limites de membres sont systÃ©matiquement vÃ©rifiÃ©es cÃ´tÃ© backend (ne pas se reposer uniquement sur le front).

Ajouter quelques tests unitaires / dâ€™intÃ©gration :

CrÃ©ation de communautÃ© â†’ plan STARTER_FREE automatiquement assignÃ©.

Ajout de membres jusquâ€™Ã  la limite â†’ OK.

Ajout de membres au-delÃ  de la limite â†’ rejetÃ©.

Downgrade vers un plan infÃ©rieur alors que member_count dÃ©passe le max_members du nouveau plan â†’ rejetÃ©.

9ï¸âƒ£ Ce que tu dois faire concrÃ¨tement dans le repo

Analyser la stack existante (framework, ORM, structure du front).

CrÃ©er :

La migration / modÃ¨le plans.

Le seed initial avec les 5 plans.

Les champs supplÃ©mentaires sur le modÃ¨le de communautÃ©.

Ajouter :

La logique de quota membres dans les services / controllers concernÃ©s.

Les endpoints & services pour changer de plan.

La page publique de pricing.

Lâ€™affichage du plan actuel et de la consommation dans le back office et lâ€™app client.

PrÃ©parer :

La structure de facturation Stripe (services, mapping plan_code â†’ stripe_price_id, etc.).

Ajouter quelques tests et commentaires TODO pour les parties Ã  implÃ©menter plus tard (webhooks Stripe, etc.).

Merci dâ€™appliquer ces changements de maniÃ¨re cohÃ©rente avec lâ€™architecture existante et de garder le code propre, typÃ© si possible (TypeScript, etc.), bien commentÃ©, et prÃªt Ã  Ã©voluer.