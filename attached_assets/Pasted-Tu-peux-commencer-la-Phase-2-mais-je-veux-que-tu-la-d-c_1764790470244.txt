Tu peux commencer la Phase 2, mais je veux que tu la dÃ©coupes en sous-phases bien distinctes :

ğŸŸ¦ Phase 2A â€“ Stripe Billing (abonnement Koomy uniquement)

Objectif :
Mettre en place lâ€™abonnement Koomy pour les communautÃ©s (plans Plus / Pro, mensuel / annuel, avec 14 jours dâ€™essai).

Merci de :

CrÃ©er / complÃ©ter server/stripeClient.ts

initialisation propre du client Stripe

lecture des variables dâ€™environnement suivantes :

STRIPE_SECRET_KEY

STRIPE_PRICE_PLUS_MONTHLY

STRIPE_PRICE_PLUS_YEARLY

STRIPE_PRICE_PRO_MONTHLY

STRIPE_PRICE_PRO_YEARLY

STRIPE_WEBHOOK_SECRET

CrÃ©er une route backend :
POST /api/payments/create-koomy-subscription-session

EntrÃ©e : communityId, billingPlan ("plus" | "pro"), billingPeriod ("monthly" | "yearly")

CrÃ©ation/rÃ©cupÃ©ration du customer Stripe

SÃ©lection du bon price_id

CrÃ©ation dâ€™une session Checkout en mode subscription avec trial_period_days: 14

Retourner session.url

Mettre Ã  jour la table communities Ã  partir des webhooks Stripe :

subscriptionStatus

billingPeriod

currentPeriodEnd

planId (lien avec la table plans dÃ©jÃ  existante)

CrÃ©er le handler de webhooks Stripe dans server/webhookHandlers.ts et le brancher dans server/index.ts :

GÃ©rer au minimum :

checkout.session.completed

customer.subscription.created

customer.subscription.updated

invoice.payment_failed

customer.subscription.deleted

Avant dâ€™implÃ©menter, merci de :

me montrer les signatures des routes,

les structures dâ€™objets que tu comptes Ã©crire en DB,

et les extraits de code principaux.

ğŸ‘‰ Dans cette Phase 2A, ne touche PAS encore Ã  Stripe Connect, ni aux cotisations, ni aux collectes.
On veut dâ€™abord un flux propre pour lâ€™abonnement Koomy.

ğŸŸ© Phase 2B â€“ Stripe Connect + paiements membres (Ã  faire aprÃ¨s validation de 2A)

Une fois la Phase 2A terminÃ©e et validÃ©e, on passera ensuite :

Ã  server/stripeConnect.ts (crÃ©ation des comptes Express pour les communautÃ©s),

aux routes create-membership-session,

puis aux collectes et aux entrÃ©es dans transactions.

Mais pas tout de suite : on valide dâ€™abord 2A.

Tu peux donc commencer par la Phase 2A (Stripe Billing) comme dÃ©crit ci-dessus, et me prÃ©senter le plan / code pour validation avant dâ€™aller plus loin.