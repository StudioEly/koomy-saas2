Replit, nous allons ajouter Ã  Koomy un systÃ¨me complet dâ€™envoi dâ€™emails, entiÃ¨rement configurable depuis la plateforme SaaS Owner.

Merci de suivre les Ã©tapes ci-dessous dans lâ€™ordre, en expliquant Ã  chaque fois ce que tu modifies et pourquoi.

ğŸ”· TÃ¢che 1 â€” CrÃ©ation du module mailer dans le backend

Dans le backend Node/Express, crÃ©er un dossier :
server/services/mailer/

Ã€ lâ€™intÃ©rieur, crÃ©er les fichiers suivants :

mailer.js â†’ la couche dâ€™intÃ©gration (SendGrid, Resend ou autre)

templates.js â†’ charge les templates stockÃ©s en base (ou fallback par dÃ©faut)

emailTypes.js â†’ liste les types dâ€™emails utilisables dans tout Koomy

renderer.js â†’ remplace les variables dynamiques dans les templates (ex: {{name}}, {{code}})

PrÃ©parer mailer.js pour supporter SendGrid par dÃ©faut :

const sgMail = require("@sendgrid/mail");
sgMail.setApiKey(process.env.SENDGRID_API_KEY);

async function sendEmail({ to, subject, html }) {
  const msg = { to, from: "no-reply@koomy.app", subject, html };
  await sgMail.send(msg);
}

module.exports = { sendEmail };


PrÃ©parer les variables dâ€™environnement nÃ©cessaires :

SENDGRID_API_KEY

EMAIL_FROM
Ajouter les placeholders dans Replit.

ğŸ”· TÃ¢che 2 â€” Ajouter un systÃ¨me de templates email (gÃ©rÃ©s depuis SaaS Owner)

CrÃ©er une nouvelle table en base de donnÃ©es : EmailTemplates

id

type (ex: "welcome_admin", "invite_member", "reset_password"...)

subject

html

updatedAt

Ajouter une route backend :

GET /api/owner/email-templates â†’ liste des templates

GET /api/owner/email-templates/:type â†’ rÃ©cupÃ©rer un template

PUT /api/owner/email-templates/:type â†’ modifier un template

Ajouter dans emailTypes.js la liste officielle :

welcome_community_admin

invite_delegate

invite_member

reset_password

verify_email

new_event

new_collection

message_to_admin

Dans renderer.js, ajouter une fonction permettant de rendre un template HTML avec des variables dynamiques :

function renderTemplate(html, variables) {
  return html.replace(/{{(.*?)}}/g, (_, key) => variables[key.trim()] || "");
}
module.exports = { renderTemplate };

ğŸ”· TÃ¢che 3 â€” Connecter les actions du produit aux emails

Dans le backend existant, ajouter lâ€™envoi dâ€™emails aux moments suivants :

CrÃ©ation dâ€™un nouvel admin + communautÃ©

type : welcome_community_admin

variables : name, communityName, code, loginUrl

Ajout dâ€™un dÃ©lÃ©guÃ©

type : invite_delegate

variables : name, adminName, communityName, role, activationUrl

Ajout dâ€™un membre

type : invite_member

variables : name, communityName, codeMembre, activationUrl

Reset password

type : reset_password

variables : name, resetUrl

VÃ©rification email

type : verify_email

variables : name, codeVerification, activateUrl

Nouvel Ã©vÃ©nement crÃ©Ã©

type : new_event

variables : title, date, communityName

Nouvelle collecte lancÃ©e

type : new_collection

variables : title, amount, deadline, communityName

Message reÃ§u dâ€™un membre

type : message_to_admin

variables : memberName, subject, message

Important :
CrÃ©er une fonction utilitaire globale :

async function sendSystemEmail(type, to, variables) {
  const template = await getTemplateByType(type);
  const html = renderTemplate(template.html, variables);
  const subject = renderTemplate(template.subject, variables);
  await sendEmail({ to, subject, html });
}

ğŸ”· TÃ¢che 4 â€” Interface de gestion dans SaaS Owner

Dans la plateforme Owner, ajouter une section :

â¡ï¸ Menu : ParamÃ¨tres â†’ Templates Email

CrÃ©er trois Ã©crans :

4.1 Liste des templates

Afficher :

Nom du template

Type

DerniÃ¨re mise Ã  jour

Bouton â€œModifierâ€

4.2 Ã‰diteur dâ€™un template

Formulaire :

Champ â€œObjetâ€

Champ â€œContenu HTMLâ€

AperÃ§u

Liste des variables dynamiques possibles pour ce type dâ€™email

Bouton : Enregistrer les modifications

4.3 Avertissement

Afficher en haut :

âš  Les emails modifiÃ©s affectent toutes les communautÃ©s utilisant Koomy.

ğŸ”· TÃ¢che 5 â€” SÃ©curitÃ© & validation

Le module email ne doit Ãªtre accessible que depuis SaaS Owner.

Ajouter une vÃ©rification du format email avant envoi.

EmpÃªcher l'injection HTML dangereuse dans les templates.

Logger les envois pour debugging :
-> table EmailLogs

id

to

type

sentAt

success/failure

errorMessage

ğŸ”· TÃ¢che 6 â€” Tester le systÃ¨me

Simuler crÃ©ation dâ€™admin â†’ vÃ©rifier email reÃ§u.

Simuler ajout dâ€™un membre â†’ vÃ©rifier email reÃ§u.

Modifier un template dans SaaS Owner â†’ relancer un email â†’ vÃ©rifier que câ€™est bien la nouvelle version.

VÃ©rifier que les placeholders {{name}}, {{code}}, etc. se remplacent correctement.

ğŸ”¥ Ã€ la fin, confirmer :

CrÃ©ation du module mailer âœ”

Ajout des templates en base âœ”

Routes API Owner pour gÃ©rer les templates âœ”

IntÃ©gration des emails dans les actions clÃ©s du backend âœ”

Interface Owner UI (liste + Ã©dition) âœ”

Logs dâ€™envoi âœ”