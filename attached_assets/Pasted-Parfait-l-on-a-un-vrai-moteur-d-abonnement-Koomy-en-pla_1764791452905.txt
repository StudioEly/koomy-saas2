Parfait, lÃ  on a un vrai moteur dâ€™abonnement Koomy en place ğŸ‰

On fait deux choses maintenant :

Configurer Stripe pour que Ã§a marche en vrai (en mode test)

Lancer proprement la Phase 2B (Stripe Connect + cotisations + collectes)

1ï¸âƒ£ Ce que toi tu dois faire maintenant dans Stripe
a) RÃ©cupÃ©rer les 4 Price IDs et les mettre dans Replit

Dans ton Dashboard Stripe :

Va dans Produits.

Clique sur :

Produit CommunautÃ© Plus â†’ onglet â€œPrixâ€ â†’ tu vois les 2 prix (9,90 et 99).

Produit CommunautÃ© Pro â†’ pareil (29,90 et 290).

Pour chaque prix, tu cliques â†’ tu copies lâ€™ID du prix (Ã§a ressemble Ã  price_1QfXYZabc...).

Puis dans Replit, dans les variables dâ€™environnement du projet Koomy, mets :

STRIPE_PRICE_PLUS_MONTHLY=price_xxx   # 9,90 â‚¬
STRIPE_PRICE_PLUS_YEARLY=price_xxx    # 99 â‚¬
STRIPE_PRICE_PRO_MONTHLY=price_xxx    # 29,90 â‚¬
STRIPE_PRICE_PRO_YEARLY=price_xxx     # 290 â‚¬


Enregistre.

b) Configurer le webhook Stripe

Dans Stripe â†’ DÃ©veloppeurs â†’ Webhooks.

Ajoute un endpoint webhook qui pointe vers lâ€™URL que Replit tâ€™a donnÃ©e pour /api/payments/stripe/webhook
(Replit a sÃ»rement affichÃ© lâ€™URL dans server/stripe.ts ou les logs, sinon tu lui demanderas).

Dans Stripe, choisis les Ã©vÃ©nements :

checkout.session.completed

customer.subscription.created

customer.subscription.updated

customer.subscription.deleted

invoice.payment_failed

Stripe va te donner un Webhook Signing Secret du type :

whsec_XXXXXXXX

Mets-le dans Replit comme variable dâ€™environnement :

STRIPE_WEBHOOK_SECRET=whsec_xxxxxxxx

c) (Optionnel mais recommandÃ©) Faire un test simple

Tu peux dÃ©jÃ  tester vite fait la route :

Appel POST /api/payments/create-koomy-subscription-session avec un communityId de test, billingPlan: "plus", billingPeriod: "monthly".

Si tout est OK â†’ Stripe te renvoie sessionUrl.

Tu lâ€™ouvres dans ton navigateur â†’ tu devrais voir la page checkout Stripe en mode test.

Si tu ne veux pas tâ€™embÃªter avec Postman, tu peux aussi dire Ã  Replit plus tard de crÃ©er un petit bouton dans le SaaS Owner, mais ce nâ€™est pas bloquant tout de suite.

2ï¸âƒ£ Lancer la Phase 2B (Stripe Connect + cotisations + collectes)

LÃ  on va lui donner un cadrage aussi propre que pour la 2A, pour Ã©viter quâ€™il fasse tout en vrac.

Tu peux lui rÃ©pondre exactement ceci ğŸ‘‡

âœ‰ï¸ Message Ã  envoyer Ã  Replit pour dÃ©marrer la PHASE 2B

OK, on peut passer Ã  la Phase 2B â€“ Stripe Connect + cotisations + collectes, mais comme pour la Phase 2A, je veux que ce soit dÃ©coupÃ© en sous-phases.

ğŸŸ¦ Phase 2B.1 â€” Stripe Connect Express (activation paiements communautÃ©)

Objectif : permettre Ã  une communautÃ© dâ€™activer les paiements en ligne via Stripe Connect Express.

Merci de :

CrÃ©er server/stripeConnect.ts avec :

une fonction pour crÃ©er un compte Connect Express pour une communautÃ© (stripeConnectAccountId)

une fonction pour gÃ©nÃ©rer un onboarding link (accountLink) avec :

refresh_url = https://backoffice.koomy.app/payments/connect/refresh

return_url = https://backoffice.koomy.app/payments/connect/success

Ajouter une route API :

POST /api/payments/connect-community


EntrÃ©e :

{ "communityId": "xxx" }


Comportement :

vÃ©rifier que lâ€™utilisateur est admin de cette communautÃ© (logique dÃ©jÃ  existante cÃ´tÃ© auth/roles),

crÃ©er un compte Express si aucun stripeConnectAccountId nâ€™est encore stockÃ©,

crÃ©er un accountLink dâ€™onboarding,

retourner { onboardingUrl } au frontend.

Mettre Ã  jour communities :

stocker stripeConnectAccountId,

prÃ©voir la mise Ã  jour de paymentsEnabled quand le compte est vraiment actif (via webhook dans une sous-phase suivante).

ğŸ‘‰ Dans cette sous-phase 2B.1, on ne sâ€™occupe que de la crÃ©ation du compte Connect + onboarding link.
Pas encore des cotisations, ni des collectes, ni des transactions.

Merci de :

me montrer la signature de la route,

le code principal de stripeConnect.ts,

et les updates sur storage avant dâ€™implÃ©menter la suite.

ğŸŸ© Phase 2B.2 â€” Paiement cotisation (membership)

Ã€ faire aprÃ¨s validation de 2B.1 :

Route POST /api/payments/create-membership-session

Utilisation de application_fee_amount + transfer_data.destination

Mise Ã  jour des tables userCommunityMemberships + transactions Ã  partir des webhooks.

On en reparlera en dÃ©tail aprÃ¨s validation de 2B.1.

ğŸŸ§ Phase 2B.3 â€” Collectes (collections)

Ã€ faire aprÃ¨s 2B.2 :

Routes POST /api/collections + POST /api/payments/create-collection-session

Utilisation de la table collections et de transactions.

Tu peux donc commencer par la Phase 2B.1 comme dÃ©crit ci-dessus, et me prÃ©senter le plan/implÃ©mentation avant de passer Ã  la suite.