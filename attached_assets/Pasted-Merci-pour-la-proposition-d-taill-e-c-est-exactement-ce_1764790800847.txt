Merci pour la proposition dÃ©taillÃ©e, câ€™est exactement ce que je voulais ğŸ™Œ
Je valide la Phase 2A avec les ajustements suivants :

1ï¸âƒ£ Route /api/payments/create-koomy-subscription-session â†’ OK âœ…

La structure de la route me convient.

Les types CreateSubscriptionSessionRequest / Response sont OK.

La logique de sÃ©lection du priceId via billingPlan + billingPeriod est bonne.

ğŸ”§ Ajustements demandÃ©s :

Ne pas utiliser req.protocol + req.get("host") pour les URLs de redirection.
On ne veut jamais exposer les URLs Replit.
Merci de mettre des URLs fixes basÃ©es sur nos domaines :

const successUrl = `https://lorpesikoomyadmin.koomy.app/subscription/success?session_id={CHECKOUT_SESSION_ID}`;
const cancelUrl  = `https://lorpesikoomyadmin.koomy.app/subscription/cancel`;


(Tu peux adapter le chemin, mais garde bien le domaine lorpesikoomyadmin.koomy.app et pas lâ€™URL Replit.)

Pour planCode = "COMMUNAUTE_STANDARD" | "COMMUNAUTE_PRO" :
vÃ©rifie que Ã§a correspond bien aux codes existants dans la table plans.
Si les codes actuels sont diffÃ©rents, merci dâ€™utiliser les vrais codes dÃ©jÃ  prÃ©sents.

2ï¸âƒ£ Champs mis Ã  jour dans communities â†’ petite correction

Tu proposes dâ€™ajouter / mettre Ã  jour :

subscriptionStatus
billingStatus
currentPeriodEnd
trialEndsAt
billingPeriod
planId


âœ… Attention :

subscriptionStatus, billingPeriod, currentPeriodEnd, planId existent dÃ©jÃ  â€” OK.

ğŸ”´ billingStatus nâ€™existe pas dans le schÃ©ma (et on ne lâ€™a pas ajoutÃ© en Phase 1).

ğŸ”´ trialEndsAt nâ€™existe pas non plus (on ne lâ€™a pas ajoutÃ© non plus).

ğŸ‘‰ Donc :

Ne crÃ©e pas de champ billingStatus pour lâ€™instant.
Contente-toi dâ€™utiliser lâ€™subscriptionStatus existant avec un mapping simple entre Stripe et notre enum.

Par exemple :

// Stripe â†’ our subscriptionStatusEnum (active, past_due, canceled)
trialing â†’ "active"
active   â†’ "active"
past_due â†’ "past_due"
canceled â†’ "canceled"
unpaid   â†’ "canceled"


Tu peux continuer Ã  mettre Ã  jour currentPeriodEnd comme tu le proposes.

Pour le trial 14 jours : on le gÃ¨re cÃ´tÃ© Stripe, mais pour lâ€™instant on ne stocke pas trialEndsAt dans la DB (on pourra ajouter un champ dÃ©diÃ© plus tard si nÃ©cessaire).

3ï¸âƒ£ Webhooks â†’ globalement OK âœ…

Les Ã©vÃ©nements gÃ©rÃ©s me conviennent :

checkout.session.completed

customer.subscription.created

customer.subscription.updated

invoice.payment_failed

customer.subscription.deleted

ğŸ”§ Ajustement :

Dans handleCheckoutCompleted, ne force pas subscriptionStatus: "active" si Stripe renvoie trialing.
On prÃ©fÃ¨re laisser customer.subscription.updated gÃ©rer lâ€™Ã©tat final :

tu peux te contenter de stocker :

stripeCustomerId

stripeSubscriptionId

planId

billingPeriod

Et laisser handleSubscriptionUpdated mettre Ã  jour :

subscriptionStatus

currentPeriodEnd.

4ï¸âƒ£ Stripe Client via Replit â†’ OK âœ…

Ta logique getStripeClient() avec le connecteur Replit me va.
Je fournirai les variables dâ€™environnement suivantes :

STRIPE_PRICE_PLUS_MONTHLY

STRIPE_PRICE_PLUS_YEARLY

STRIPE_PRICE_PRO_MONTHLY

STRIPE_PRICE_PRO_YEARLY

STRIPE_WEBHOOK_SECRET (pour la validation de la signature webhook)

5ï¸âƒ£ RÃ©ponses Ã  tes questions

La structure de la route vous convient-elle ?
âœ… Oui, avec les ajustements dâ€™URL ci-dessus.

Les champs mis Ã  jour dans communities sont-ils corrects ?
âœ… Oui, sauf billingStatus et trialEndsAt que nous ne stockons pas pour lâ€™instant (pas de colonnes).
On reste sur subscriptionStatus, billingPeriod, currentPeriodEnd, planId.

Les webhooks couvrent-ils tous les cas ?
âœ… Oui, câ€™est suffisant pour la V1.

Faut-il crÃ©er les produits/prix Stripe maintenant ou avez-vous dÃ©jÃ  les price IDs ?
âœ… Les produits/prix Stripe existent dÃ©jÃ , jâ€™utiliserai les Price IDs pour remplir les variables dâ€™environnement.

ğŸŸ¢ Conclusion

âœ… Tu peux implÃ©menter la Phase 2A maintenant,
en prenant en compte :

la suppression de billingStatus / trialEndsAt dans les updates,

le mapping Stripe â†’ subscriptionStatus,

les success/cancel URLs basÃ©es sur nos domaines Koomy (pas Replit).

Ensuite, on validera ensemble cette phase avant de passer Ã  la Phase 2B (Stripe Connect + cotisations + collectes