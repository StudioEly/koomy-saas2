Parfait, √ßa avance super bien üî•
L√† oui, on le fait passer en Phase 2B.2 ‚Äì Paiement des cotisations, mais comme d‚Äôhab : cadrage b√©ton.
Tu peux lui r√©pondre exactement √ßa :

‚úÖ Oui, on passe √† la PHASE 2B.2 ‚Äì Paiement des cotisations (membership)
On se concentre uniquement sur la cotisation d‚Äôadh√©sion √† une communaut√© (pas encore les collectes).

üéØ Objectif de la Phase 2B.2
Permettre √† un membre de payer sa cotisation √† une communaut√© via Stripe Checkout, en :


d√©bitant le membre via Stripe,


reversant l‚Äôargent au compte Connect de la communaut√©,


appliquant la commission Koomy = 2% (ou platformFeePercent),


mettant √† jour :


userCommunityMemberships (paid, dates),


transactions (trace compl√®te du paiement).





1Ô∏è‚É£ Route API ‚Äì Paiement de cotisation
Cr√©er la route :
POST /api/payments/create-membership-session

Entr√©e attendue
interface CreateMembershipSessionRequest {
  communityId: string;
  memberId: string; // ou d√©riv√© de l'utilisateur courant
}


üîí La route doit utiliser la logique d‚Äôauthentification existante pour s‚Äôassurer que :


le membre est bien connect√©,


il appartient √† cette communaut√©.



Sortie
interface CreateMembershipSessionResponse {
  sessionId: string;
  sessionUrl: string;
}


2Ô∏è‚É£ Conditions avant de cr√©er la session Stripe
Avant de cr√©er la session Checkout :


R√©cup√©rer la communaut√© (communityId) :


stripeConnectAccountId doit √™tre d√©fini


paymentsEnabled doit √™tre true


membership_amount_cents (ou membershipAmountCents) doit √™tre > 0


membership_currency = "EUR"




R√©cup√©rer l‚Äôentr√©e userCommunityMemberships pour ce memberId + communityId.


Si l‚Äôune des conditions n‚Äôest pas remplie ‚Üí retourner une erreur claire (400).



3Ô∏è‚É£ Cr√©ation de la session Stripe
Utiliser Stripe Checkout en mode payment, pas subscription.
Commission Koomy
const amount = community.membershipAmountCents; // ex: 8000
const feePercent = community.platformFeePercent ?? 2;
const applicationFeeAmount = Math.round(amount * feePercent / 100);

Appel Stripe
const stripe = await getStripeClient();

const session = await stripe.checkout.sessions.create({
  mode: "payment",
  payment_method_types: ["card"],
  line_items: [
    {
      price_data: {
        currency: "eur",
        product_data: {
          name: `Cotisation ${community.name}`,
        },
        unit_amount: amount,
      },
      quantity: 1,
    },
  ],
  payment_intent_data: {
    application_fee_amount: applicationFeeAmount,
    transfer_data: {
      destination: community.stripeConnectAccountId,
    },
    metadata: {
      type: "membership",
      communityId,
      memberId,
    },
  },
  metadata: {
    type: "membership",
    communityId,
    memberId,
  },
  success_url: "https://app.koomy.app/payment/success?session_id={CHECKOUT_SESSION_ID}",
  cancel_url: "https://app.koomy.app/payment/cancel",
});


‚ùó Important :


Toujours utiliser https://app.koomy.app/... pour les URLs, jamais l‚ÄôURL Replit.


type: "membership" doit √™tre pr√©sent dans metadata (session + payment_intent).



R√©ponse :
res.json({
  sessionId: session.id,
  sessionUrl: session.url,
});


4Ô∏è‚É£ Webhooks ‚Äì Mise √† jour DB apr√®s paiement
Dans server/webhookHandlers.ts, compl√©ter la logique Stripe pour :
√âv√©nement cl√©


payment_intent.succeeded


Quand tu re√ßois cet √©v√©nement :


R√©cup√©rer paymentIntent.metadata :


type


communityId


memberId




Si type !== "membership" ‚Üí ignorer (ce sera utilis√© plus tard pour collection).


R√©cup√©rer la communaut√© et le membership.


Calculer les montants :


const amountTotal = paymentIntent.amount; // en cents
const feeKoomy = paymentIntent.application_fee_amount || 0;
const amountToCommunity = amountTotal - feeKoomy; // (on ignore pour l'instant les frais Stripe)



Cr√©er une entr√©e dans transactions :


await storage.insertTransaction({
  communityId,
  membershipId: membership.id,
  type: "membership",
  amountTotalCents: amountTotal,
  amountFeeKoomyCents: feeKoomy,
  amountToCommunity: amountToCommunity,
  currency: paymentIntent.currency?.toUpperCase() || "EUR",
  stripePaymentIntentId: paymentIntent.id,
  stripeChargeId: paymentIntent.latest_charge as string | null,
  stripeTransferId: /* si dispo via events, sinon null */,
  stripeApplicationFeeId: /* si dispo via events, sinon null */,
  status: "succeeded",
  metadata: {
    memberId,
    communityId,
  },
});



Mettre √† jour userCommunityMemberships :




membershipPaidAt = now


membershipValidUntil = now + 1 an (ceci est important : on part sur une cotisation annuelle pour le MVP)


membershipAmountPaid = amountTotal



5Ô∏è‚É£ Variables & contraintes


La commission Koomy par d√©faut = 2% via community.platformFeePercent.


La cotisation est annuelle pour cette V1 (pas besoin de g√©rer mensuel maintenant).


L‚Äôimpl√©mentation doit utiliser les types et tables ajout√©s en Phase 1 (transactions, membershipPaidAt, etc.).


Ne pas encore toucher √† collections dans cette phase.



6Ô∏è‚É£ Ce que j‚Äôattends de toi pour cette phase


Le code de la route :


signature,


validations d‚Äôentr√©e,


appel Stripe,


gestion erreurs.




Les ajouts dans le webhook handler :


gestion du payment_intent.succeeded pour type = "membership".




La mise √† jour de userCommunityMemberships + transactions.


Ensuite, on testera le flux, puis on encha√Ænera sur 2B.3 (collectes).

Tu peux commencer la Phase 2B.2 sur cette base, et me faire un r√©capitulatif comme pour les phases pr√©c√©dentes une fois termin√©.
