OK pour la PHASE 2B.3 ‚Äì Collectes / Fundraising

Nous pouvons passer √† la Phase 2B.3.
L‚Äôobjectif est de permettre √† une communaut√© de cr√©er des collectes ponctuelles, et aux membres de payer leur contribution via Stripe Checkout, avec :

reversement automatique au compte Connect de la communaut√©,

commission Koomy appliqu√©e (2% ou platformFeePercent),

enregistrement dans la table transactions,

mise √† jour des montants collect√©s.

üü¶ Phase 2B.3 ‚Äì D√©tails de la fonctionnalit√©
1Ô∏è‚É£ Route API : cr√©ation d‚Äôune collecte

Cr√©er la route :

POST /api/collections


Entr√©e :

{
  communityId: string,
  title: string,
  description?: string,
  amountCents: number,
  allowCustomAmount?: boolean,
  targetAmountCents?: number,
  deadline?: string | null
}


Contraintes :

L‚Äôutilisateur doit √™tre admin ou d√©l√©gu√© avec droit de cr√©er des collectes.

La communaut√© doit avoir :

stripeConnectAccountId

paymentsEnabled = true

Stockage :

entr√©e dans la table collections

Retour :

{
  collectionId: string
}

2Ô∏è‚É£ Route API : paiement d‚Äôune collecte

Cr√©er la route :

POST /api/payments/create-collection-session


Entr√©e :

{
  communityId: string,
  collectionId: string,
  memberId?: string,
  amountCents?: number  // requis si allowCustomAmount = true
}


Logique :

V√©rifier que la collecte existe et appartient √† cette communaut√©.

V√©rifier que la collecte est open.

V√©rifier amountCents si allowCustomAmount = true.

Calcul commission Koomy :

feePercent = collection.platformFeePercent ?? community.platformFeePercent ?? 2;
applicationFeeAmount = Math.round(amount * feePercent / 100);


Cr√©er une session Stripe Checkout :

mode: "payment",
payment_intent_data: {
  application_fee_amount,
  transfer_data: {
    destination: community.stripeConnectAccountId
  },
  metadata: {
    type: "collection",
    communityId,
    collectionId,
    memberId,
  }
},
metadata: {
  type: "collection",
  communityId,
  collectionId,
  memberId,
}


success_url = https://app.koomy.app/payment/success?session_id={CHECKOUT_SESSION_ID}
cancel_url = https://app.koomy.app/payment/cancel

Retour :

{
  sessionId: string,
  sessionUrl: string
}

3Ô∏è‚É£ Webhook : payment_intent.succeeded pour "collection"

Modifier le webhook existant :

Quand paymentIntent.metadata.type === "collection" :

Cr√©er une transaction :

type = "collection"
communityId
collectionId
memberId
amountTotalCents
amountFeeKoomyCents
amountToCommunity
stripePaymentIntentId
status = "succeeded"


Mettre √† jour la table collections :

collectedAmountCents += amountTotalCents

participantsCount += 1

(optionnel MVP) Si targetAmountCents atteint :

passer la collecte en status = "closed".

4Ô∏è‚É£ Route API : r√©cup√©rer les collectes pour app membre

Cr√©er :

GET /api/collections/:communityId


Retour :

collectes open

avec :

montant,

% atteint,

deadline,

allowCustomAmount

pour affichage dans l'app membre.

5Ô∏è‚É£ Que je veux avant impl√©mentation

Comme pour les autres phases, merci de :

Me montrer les signatures exactes des routes (POST /api/collections, POST /api/payments/create-collection-session).

Le plan de mise √† jour DB pour :

collections

transactions

Le code principal pr√©vu pour le webhook.

Les validations ajout√©es (admin, communaut√© active, paiements activ√©s, etc.)

Ensuite seulement, tu pourras impl√©menter la Phase 2B.3.

Tu peux commencer.